---
  - name: Copy image to host
    copy:
      src: ~/testreuse-atm.tar
      dest: ~/testreuse-atm.tar


  - name: Load image from archive
      command: docker import ~/testreuse-atm.tar testreuse-atm

  - name: Create a container
    docker_container:
      name: testreuse-atm
      image: testreuse-atm
      privileged: yes
      volumes:
        - /home/usiusi/models:/root/models
      command: sleep infinity


  - name: Copy config sample to host
    copy:
      src: "config_sample{{host_id}}.csv"
      dest: ~/config_sample.csv


  - name: Copy smaple config to docker
    command: docker cp ~/config_sample.csv testreuse-atm:~/test-reuse/atm/atm_runner

  - name: Create bert screen
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -dmS bert; screen -S bert -X stuff 'bash\n'"
      chdir: /root/test-reuse/matching-server


  - name: Run bert
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -S bert -X stuff 'source venv-bert/bin/activate; bert-serving-start -model_dir /root/models/bert/uncased_L-12_H-768_A-12 -num_worker=1 -port 3333 -port_out 3334\n'"
    tags:
      - debug


  - name: Create server screen
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -dmS server; screen -S server -X stuff 'bash\n'"
      chdir: /root/test-reuse/matching-server


  - name: Run matching server
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -S server -X stuff 'source venv/bin/activate; python server.py\n'"


  - name: Create emulator screen
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -dmS emulator; screen -S emulator -X stuff 'bash\n'"


  - name: Run Emulator
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -S emulator -X stuff 'emulator -ports 5554,5555 -avd emulator1 -no-window -no-audio\n'"


  - name: Create atm screen
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -dmS atm; screen -S atm -X stuff 'bash\n'"
      chdir: ~/test-reuse/atm/atm_runner


  - name: Prepare atm screen
    community.docker.docker_container_exec:
      container: testreuse-atm
      command: bash -c "screen -S server -X stuff 'source venv/bin/activate\n'"
